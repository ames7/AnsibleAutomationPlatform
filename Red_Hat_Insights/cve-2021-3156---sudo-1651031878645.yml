---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# CVE-2021-3156 - sudo
# https://console.redhat.com/insights/remediations/46686c9d-108a-47e3-95ed-6507ce11c0db
# Generated by Red Hat Insights on Wed, 27 Apr 2022 03:57:58 GMT
# Created by zigfreed

# Fixes vulnerabilities:CVE-2021-3156:CVE_2021_3156_sudo|CVE_2021_3156_SUDO
# Identifier: (vulnerabilities:CVE-2021-3156:CVE_2021_3156_sudo|CVE_2021_3156_SUDO,fix)
# Version: cd08aef35e26113f21f10e47d66b31c7fa8ed241
# CVE-2021-3156 Mitigation
# This playbook will install systemtap utilities and create a systemap script to prevent
# sudo from being executed as sudoedit. The script will need to be installed each time
# the system is booted to be effective. You can use this playbook to install the script
# after booting.

# To verify that the script is installed, issue the command `lsmod` and look for
# `sudoedit_block` in the list of loaded modules.
#
# To remove the script after a fixed package has been installed, find the process ID of
# systemtap with pgrep or ps, for example:
#
#  [root@host ~]# ps $(pgrep stap)
#  23344
#
# Then, kill the systemtap process with the SIGTERM signal:
#
#  [root@host ~]# kill -s SIGTERM 23344
#
# Alternatively, you can reboot the system. When no longer needed,
# /root/sudoedit-block.stap and /root/sudoedit-block.log can be removed.

- name: Block sudoedit with systemtap
  hosts: "rhel7.internal.ames.net"
  become: true

  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVc3hUREJ6ZG5jMU9FUXJhalZ3VGtGUmFpOXhkeTh2WVcxUmEw
      WjBiRkJTV1hkUlFuRkhNV1pGU2xZM05GcFViakEyVld0d1V5c0tjWEJTVEdkVGRGWkpSbGhGYmxa
      MlluRnBVRWN5T1ZRNWFUUXlNVEpNVlZwR1RsZDBhSEphYlRJdmIwMUhTblZQT1VGVFFUVjRWVlZO
      WjFwTWVUYzJSd3ByZWtsaGRHaHBObU0zU2tsYWNHdGtXVVJJYkhwQmVHOUpaSFJJYjNSUWEzcG5i
      VmxqVkdRMFMySTFUalZaWTJ0aWVtZExaM2xVUkhCcFFWSlVkMmN5Q2xoVFdXcDJSV1pFVjFwVU9D
      dHNZemhIYUU1aU1XNWpTV1ZZWTBsSE1XNHlOMjlYY0c1d2R6QnhTVlJJVUdacE5VWlJhRlJOU25a
      YVVXWnJOMkpzYkNzS1VVMUVMM0ZrZGtObGVUbElXR3BwWVRkR05XWnhTMWRhVUcxeVlYVldURGhD
      VEM5MGVDdE5ORk51U1RkTWJ6VlRVRmhRWjFOVGNUQTBUVWh3SzFVMFZ3cE1WakpEVEROMWR6UXlR
      V3M0ZEM5MU9EZEpSMUZ0WVZnNE4xZEpUMlpJZVVSTFZucDBiR2hWVDBKd1ZXNXFNMVozZVRWak1W
      ZEdiRkY1TkRkR2VFVjBDbXRRY1RWdVFubEhWVzFSWTNac1VGaFdhemRpYldaUmJXbEtjVmxoUTA1
      SE1HdzJNemN6Y2tsUWJHSkpUMlpGVm10TVJreFdTRkJJU1hScFNHTm5iMmNLVGtoRVN6RnpSalJN
      WnpCclJHTkNhRkE0Vm05M2JqTXZRMVZZUTJOTWREWnlWRTVIVVZwTWVXNVJjWGxwVDNSNVVVRkxV
      VmM1TjJKaVVVaGpNWEZxVmdwWlpWaEZlVFpXZDNrek9VRTNPVU5ZWlRJd2MyTkRTMVJKY2s1aWNX
      RTRZMGgzZGprNVIwUkdkSE5OWjFobk5rYzBkV2cyVVhWcFZIcG5hbWxaTTNkcUNtdzVObUkxWkVW
      bWVrazROalZ6Y1cxU016UkVlQzlVTkVkSWMzaHRWRFZ2VVhGRVQybENNRTVwUTJsQ1YwcFJlRUZS
      Ynpod05IRm1iVU5xUldSVE4wUUthR2xPUWpJeU9WQkdLMDQwU1RoS0wyRlNja2RSU0ZkNWNEUjFl
      amxsWjNoVmJrRTBkMEo1WnpsbWVsSXJSek5hUlVOc2JqWkVaRUZ6YkhSdlRFTTNUUXB4TTBsbGNF
      aHNkRFV2YXowS1BVdDFVM2NLTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: Install systemtap packages
      yum:
        name:
          - systemtap
          - yum-utils
          - kernel-devel-{{ ansible_kernel }}

    - when: ansible_distribution_major_version == '7'
      name: (RHEL 7) Install kernel debuginfo
      command: debuginfo-install -y kernel-{{ ansible_kernel }}

    - when: (ansible_distribution_major_version == '6' or ansible_distribution_major_version == '8')
      name: (RHEL 6/8) Install sudo debuginfo
      command: debuginfo-install -y sudo

    - when: ansible_distribution_major_version == '6'
      name: (RHEL 6) Install libselinux-python
      yum:
        name:
          - libselinux-python

    - name: Create systemtap script
      copy:
        dest: /root/sudoedit-block.stap
        owner: root
        group: root
        mode: '0600'
        force: no
        content: |
          probe process("/usr/bin/sudo").function("main") {
            command = cmdline_args(0,0,"");
            if (isinstr(command, "edit")) {
              raise(9);
            }
          }

    - name: Checking if sudoedit_block module is already loaded
      command: grep -Fq sudoedit_block /proc/modules
      register: loaded_module
      changed_when: loaded_module.rc == 1 # report as changed if not loaded
      failed_when: loaded_module.rc == 2
      check_mode: no

    - when: loaded_module.rc == 1
      name: Install systemtap script
      command: stap -F -o /root/sudoedit-block.log -S 1 -m sudoedit_block -g /root/sudoedit-block.stap


- name: run insights
  hosts: "rhel7.internal.ames.net"
  become: true
  gather_facts: false
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVaHBRaXR6ZG5jMU9FUXJhalZ3VGtGUmFXdDRaeTh2WmtaRFoz
      QXlTblIxVEd0UU5qQnNTa3BZYm1GU1JGTjVjVVYwU0ZSNlRGY0tOVlZSVlc5MWEyUmpVRFJVUlZn
      d01EaDFhRkJHUzFaSmVrdFVTR2RsYTFOaU1UUXlkMjlQYm5sR2VUUnpRbEJrZEZoaGREVlliWEp0
      VGxsR1EwaEVWZ28xYVhSdlNrcDBPVzg1UWtkQlJVaDVZMFJ3SzBoNVNqWXphM0paZVRGUk1rOXVU
      azF3VjJaSmNtYzJUakJXVTJoa1JtVk1lR0ppTjBaMlpFaEpjbFo2Q2pJNGFrdHhOemx1Tm13eUx6
      aDZZVkJSTDFkWVZIWkNaMDVhUkVWTFJ6TmhSSFl3WVRkbWIyUnlPRWhEZGxseE5tNUhNRkZOY1RO
      U1ZFOXBkbFZtTTFnS1JuQnlhVTh2TDNKSlRDOVlSelE1TTA1NGFWSjBRakVyZEhSUk0wZHNhM1ZE
      ZFVwck1EQkdaREp0ZDNZNFprRnZaR2xUUW5aelQydEpZekZyV25adFN3cEJjR3BEY1ZKMWVHaExU
      MDgzYWxZM1FYSnRTV0p6TkhobVJrUkJVMkZaV2t4R01VMHZhME42ZWs1d1MwTjFhbE5hVUUxRlVt
      WlhhV2RHVGpGMWRqRjNDalpQSzB0b1pTdFJVRU5hUm5CV1kwVndSbTFSTVdwcWFrOVFPV2haSzNW
      alZWSnhSVEkyTlhGTWRuWnFSWE4wUW5WQk4xQkZNRVZ3UkRsaU5VaFZSM1lLTkZKemJXc3pNbFpC
      Vnl0WE5IWk1VRWQwZG1sQ00wSXpUbE0wZUhCdVIzSmlObGs1Y1cwNFZuVTJSRUZIV2xOYWRsbFlk
      bWQwTm1WR2N6RTVTVFZZUWdvMGVtcFVSRUlyTW1sT2NrcE9jM2d5YURoU1VGVnJMMmhZUzFKMGEy
      WnZZMlpKZVRkcGNWY3hiMGRsTlZSMmFqTTFSbXRqUld0YU9VRnpSMjl6WXpWMENuUlZkVlZJWWpS
      ME5EVTFSSE5EWlZWc1ZEZFNOakJDTTB4d1Z6TmlTRTF0YzFCMEx6RktNRFEwYm1KS2RFTkhUM1Jy
      UVVWWVRsVTJlbGxUTDNBMFFqSUtaSFYxY2tZdlNHUnFWWFJNVDNSdlNFTnlZVWd2WkZwaFRVNTZk
      MVZpZUc1VFZXUkdZU3R6TTBaNFJHczFVVkU0VVRaMVVucFpRbWw0WkcxeWREZGpUQXBKYTA1NlEy
      aHBRMDlrY3owS1BVMVZOMk1LTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false