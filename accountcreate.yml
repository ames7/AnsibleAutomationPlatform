---
  - name: Create Local Account
    hosts: all
    gather_facts: yes
    vars:
       ansible_svc_account: "{{ account }}"
       ansible_home_directory: "{{ home_directory }}"
       account_sudoers: "{{ account_sudoer }}"
       user_comment: "{{ user_comment }}"
       public_key: "{{ public_key }}"

    tasks:
    
    - name: 'Preflight Varible check :: account'
      fail: msg='Please include the account to the variable "account"'
      run_once: true
      when: 'account is not defined'
      
    - name: 'Preflight Varible check :: home_directory'
      fail: msg='Please include the home_directory to the variable "home_directory"'
      run_once: true
      when: 'home_directory is not defined'
     
    - name: Creating the "{{ account }}" user account and the "{{ home_directory }}/{{ account }}" home directory
      user:
        name: "{{ account }}"
        home: "{{ home_directory }}/{{ account }}"
        create_home: true
        comment: "{{ user_comment }}"
        state: present
        remove: false
        system: true
 
    - name: "{{ account }} is included in sudoers.d directory"
      copy:
        dest: "/etc/sudoers.d/{{ account }}"
        content: "{{ account }} ALL=(ALL) NOPASSWD: ALL\n"
        owner: root
        group: root
        mode: 'ug+rwX,o='
      when: account_sudoer == 'true'
      
    - name: Making sure the public key for the "{{ account }}" account is present
      authorized_key:
        user: "{{ account }}"
        state: present
        key: "{{ public_key }}"
      when: public_key != 'false'
